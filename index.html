import React, { useState } from 'react';
import { Sparkles, Code, CheckCircle, ArrowRight } from 'lucide-react';

const CodeQuest = () => {
  const [currentLevel, setCurrentLevel] = useState(0);
  const [userCode, setUserCode] = useState('');
  const [feedback, setFeedback] = useState('');
  const [completedLevels, setCompletedLevels] = useState([]);
  const [showHint, setShowHint] = useState(false);

  const levels = [
    {
      id: 0,
      title: "Hutan Terkutuk",
      story: "Kamu adalah murid penyihir muda. Mentormu meninggalkan gulungan ajaib berisi petunjuk. Untuk membuka gerbang kuno, kamu harus menyatakan namamu menggunakan mantra 'let'.",
      concept: "Variabel",
      task: "Buat variabel bernama 'namaPenyihir' dan isi dengan namamu (dalam tanda kutip).",
      hint: "Coba: let namaPenyihir = \"NamaMu\";",
      image: (
        <svg viewBox="0 0 400 300" className="w-full h-48">
          <rect fill="#1a5f3f" width="400" height="300"/>
          <circle cx="80" cy="80" r="40" fill="#2d7a4f"/>
          <circle cx="180" cy="60" r="50" fill="#2d7a4f"/>
          <circle cx="300" cy="100" r="45" fill="#2d7a4f"/>
          <rect x="170" y="180" width="60" height="80" fill="#5d4037"/>
          <path d="M 150 180 L 200 140 L 250 180 Z" fill="#6d4c41"/>
          <rect x="185" y="210" width="30" height="40" fill="#3e2723"/>
          <circle cx="200" cy="120" r="3" fill="#ffeb3b"/>
          <circle cx="220" cy="115" r="2" fill="#ffeb3b"/>
          <circle cx="180" cy="125" r="2" fill="#ffeb3b"/>
        </svg>
      ),
      solution: (code) => {
        return code.includes('let') && 
               code.includes('namapenyihir') && 
               code.includes('=') &&
               (code.includes('"') || code.includes("'"));
      },
      explanation: "Variabel menyimpan informasi! 'let' membuat wadah untuk menyimpan data."
    },
    {
      id: 1,
      title: "Jembatan Keputusan",
      story: "Sebuah jembatan ajaib muncul, tapi hanya mengizinkan penyihir dengan kekuatan magis 50+ untuk menyeberang. Cek apakah level kekuatanmu cukup tinggi!",
      concept: "Kondisional (pernyataan if)",
      task: "Tulis pernyataan if yang mengecek apakah kekuatanMagis lebih besar atau sama dengan 50.",
      hint: "Coba: if (kekuatanMagis >= 50) { }",
      image: (
        <svg viewBox="0 0 400 300" className="w-full h-48">
          <rect fill="#87ceeb" width="400" height="300"/>
          <ellipse cx="200" cy="250" rx="150" ry="30" fill="#4682b4"/>
          <rect x="120" y="150" width="160" height="15" fill="#8b4513" rx="5"/>
          <line x1="120" y1="150" x2="100" y2="240" stroke="#654321" strokeWidth="4"/>
          <line x1="280" y1="150" x2="300" y2="240" stroke="#654321" strokeWidth="4"/>
          <line x1="160" y1="150" x2="150" y2="240" stroke="#654321" strokeWidth="3"/>
          <line x1="240" y1="150" x2="250" y2="240" stroke="#654321" strokeWidth="3"/>
          <circle cx="50" cy="80" r="30" fill="#ffeb3b" opacity="0.8"/>
          <text x="200" y="165" fontSize="24" fill="#ffffff" textAnchor="middle" fontWeight="bold">?</text>
        </svg>
      ),
      solution: (code) => {
        return code.includes('if') && 
               code.includes('kekuatanmagis') &&
               (code.includes('>=') || code.includes('>'));
      },
      explanation: "Pernyataan if membuat kode membuat keputusan berdasarkan kondisi!"
    },
    {
      id: 2,
      title: "Gua Kristal",
      story: "Kamu menemukan 5 kristal ajaib! Setiap kristal perlu diisi dengan mantra. Kamu harus melempar mantra berulang-ulang.",
      concept: "Perulangan (Loop)",
      task: "Tulis perulangan for yang menghitung dari 1 sampai 5.",
      hint: "Coba: for (let i = 1; i <= 5; i++) { }",
      image: (
        <svg viewBox="0 0 400 300" className="w-full h-48">
          <rect fill="#2c1b47" width="400" height="300"/>
          <ellipse cx="200" cy="280" rx="180" ry="40" fill="#1a0f2e"/>
          <polygon points="80,120 100,180 60,180" fill="#9c27b0" opacity="0.7"/>
          <polygon points="140,100 160,170 120,170" fill="#e91e63" opacity="0.7"/>
          <polygon points="200,80 220,160 180,160" fill="#00bcd4" opacity="0.7"/>
          <polygon points="260,100 280,170 240,170" fill="#4caf50" opacity="0.7"/>
          <polygon points="320,120 340,180 300,180" fill="#ffc107" opacity="0.7"/>
          <circle cx="90" cy="130" r="4" fill="#ffffff"/>
          <circle cx="150" cy="110" r="4" fill="#ffffff"/>
          <circle cx="210" cy="90" r="4" fill="#ffffff"/>
          <circle cx="270" cy="110" r="4" fill="#ffffff"/>
          <circle cx="330" cy="130" r="4" fill="#ffffff"/>
        </svg>
      ),
      solution: (code) => {
        return code.includes('for') && 
               code.includes('let') &&
               code.includes('<=') &&
               code.includes('i++');
      },
      explanation: "Perulangan mengulang aksi! Ini menghemat waktu dari menulis kode yang sama berkali-kali."
    },
    {
      id: 3,
      title: "Perpustakaan Mantra",
      story: "Perpustakaan kuno berisi buku-buku mantra. Kamu perlu membuat mantramu sendiri yang bisa digunakan berulang kali!",
      concept: "Fungsi",
      task: "Buat fungsi bernama 'lemparMantra' tanpa parameter.",
      hint: "Coba: function lemparMantra() { }",
      image: (
        <svg viewBox="0 0 400 300" className="w-full h-48">
          <rect fill="#5d4037" width="400" height="300"/>
          <rect x="40" y="80" width="80" height="180" fill="#3e2723"/>
          <rect x="50" y="90" width="15" height="20" fill="#d32f2f"/>
          <rect x="70" y="90" width="15" height="20" fill="#1976d2"/>
          <rect x="90" y="90" width="15" height="20" fill="#388e3c"/>
          <rect x="160" y="60" width="80" height="200" fill="#3e2723"/>
          <rect x="170" y="70" width="15" height="20" fill="#fbc02d"/>
          <rect x="190" y="70" width="15" height="20" fill="#7b1fa2"/>
          <rect x="210" y="70" width="15" height="20" fill="#0288d1"/>
          <rect x="280" y="90" width="80" height="170" fill="#3e2723"/>
          <rect x="290" y="100" width="15" height="20" fill="#c2185b"/>
          <rect x="310" y="100" width="15" height="20" fill="#00796b"/>
          <rect x="330" y="100" width="15" height="20" fill="#f57c00"/>
          <circle cx="200" cy="30" r="15" fill="#ffeb3b" opacity="0.6"/>
          <rect x="195" y="30" width="10" height="40" fill="#ffeb3b" opacity="0.4"/>
        </svg>
      ),
      solution: (code) => {
        return code.includes('function') && 
               code.includes('lemparmantra') &&
               code.includes('(') &&
               code.includes(')');
      },
      explanation: "Fungsi adalah blok kode yang bisa digunakan ulang! Seperti membuat mantra kustommu sendiri."
    },
    {
      id: 4,
      title: "Tantangan Naga",
      story: "Naga menjaga harta karun! Dia bertanya: 'Gabungkan semua pengetahuanmu - buat mantra yang menggunakan variabel, mengecek kondisi, melakukan perulangan, dan dalam sebuah fungsi!'",
      concept: "Menggabungkan Konsep",
      task: "Buat fungsi dengan variabel, pernyataan if, dan perulangan for.",
      hint: "Gabungkan semua yang sudah kamu pelajari! Mulai dengan 'function'...",
      image: (
        <svg viewBox="0 0 400 300" className="w-full h-48">
          <rect fill="#ff6b35" width="400" height="300"/>
          <ellipse cx="200" cy="180" rx="80" ry="60" fill="#d32f2f"/>
          <ellipse cx="180" cy="140" rx="50" ry="40" fill="#c62828"/>
          <circle cx="160" cy="130" r="8" fill="#ffeb3b"/>
          <circle cx="200" cy="130" r="8" fill="#ffeb3b"/>
          <path d="M 150 100 L 170 80 L 160 100 Z" fill="#d32f2f"/>
          <path d="M 210 100 L 190 80 L 200 100 Z" fill="#d32f2f"/>
          <path d="M 220 180 L 280 160 L 270 190 Z" fill="#b71c1c"/>
          <path d="M 220 200 L 280 220 L 270 200 Z" fill="#b71c1c"/>
          <ellipse cx="140" cy="240" rx="30" ry="15" fill="#ffd700"/>
          <ellipse cx="180" cy="245" rx="25" ry="12" fill="#ffd700"/>
          <ellipse cx="160" cy="250" rx="20" ry="10" fill="#ffeb3b"/>
          <path d="M 150 150 Q 180 165 150 170" fill="none" stroke="#ff9800" strokeWidth="3"/>
        </svg>
      ),
      solution: (code) => {
        return code.includes('function') &&
               code.includes('let') &&
               code.includes('if') &&
               code.includes('for');
      },
      explanation: "Kamu sudah menguasai menggabungkan konsep coding! Beginilah cara program asli dibuat."
    }
  ];

  const handleSubmit = () => {
    const level = levels[currentLevel];
    const isCorrect = level.solution(userCode.toLowerCase());
    
    if (isCorrect) {
      setFeedback('âœ¨ Benar! Sihirnya berhasil!');
      if (!completedLevels.includes(currentLevel)) {
        setCompletedLevels([...completedLevels, currentLevel]);
      }
    } else {
      setFeedback('âŒ Belum tepat. Coba lagi atau lihat petunjuknya!');
    }
  };

  const nextLevel = () => {
    if (currentLevel < levels.length - 1) {
      setCurrentLevel(currentLevel + 1);
      setUserCode('');
      setFeedback('');
      setShowHint(false);
    }
  };

  const currentLevelData = levels[currentLevel];
  const isCompleted = completedLevels.includes(currentLevel);
  const allCompleted = completedLevels.length === levels.length;

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 text-white p-6">
      <div className="max-w-4xl mx-auto">
        {/* Header */}
        <div className="text-center mb-8">
          <div className="flex items-center justify-center gap-2 mb-2">
            <Sparkles className="w-8 h-8 text-yellow-400" />
            <h1 className="text-4xl font-bold">Petualangan Kode</h1>
            <Sparkles className="w-8 h-8 text-yellow-400" />
          </div>
          <p className="text-purple-300">Belajar coding melalui petualangan ajaib!</p>
        </div>

        {/* Progress */}
        <div className="bg-white/10 backdrop-blur rounded-lg p-4 mb-6">
          <div className="flex items-center justify-between mb-2">
            <span className="text-sm font-semibold">Perjalananmu</span>
            <span className="text-sm">{completedLevels.length} / {levels.length} Level</span>
          </div>
          <div className="flex gap-2">
            {levels.map((level, idx) => (
              <div
                key={idx}
                className={`flex-1 h-2 rounded-full ${
                  completedLevels.includes(idx)
                    ? 'bg-green-400'
                    : idx === currentLevel
                    ? 'bg-yellow-400'
                    : 'bg-white/20'
                }`}
              />
            ))}
          </div>
        </div>

        {allCompleted ? (
          <div className="bg-gradient-to-r from-yellow-400/20 to-orange-400/20 backdrop-blur rounded-lg p-8 text-center">
            <Sparkles className="w-16 h-16 text-yellow-400 mx-auto mb-4" />
            <h2 className="text-3xl font-bold mb-4">ðŸŽ‰ Petualangan Selesai!</h2>
            <p className="text-xl mb-4">Kamu sudah menguasai dasar-dasar sihir coding!</p>
            <p className="text-purple-300">Kamu sudah belajar: Variabel, Kondisional, Perulangan, Fungsi, dan cara menggabungkannya!</p>
            <button
              onClick={() => {
                setCurrentLevel(0);
                setCompletedLevels([]);
                setUserCode('');
                setFeedback('');
              }}
              className="mt-6 bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-semibold"
            >
              Mulai Petualangan Baru
            </button>
          </div>
        ) : (
          <>
            {/* Story Card */}
            <div className="bg-white/10 backdrop-blur rounded-lg p-6 mb-6">
              <div className="flex items-start gap-3 mb-4">
                <Code className="w-6 h-6 text-blue-400 mt-1" />
                <div className="flex-1">
                  <h2 className="text-2xl font-bold mb-2">{currentLevelData.title}</h2>
                  <span className="inline-block bg-blue-500/30 px-3 py-1 rounded-full text-sm mb-3">
                    {currentLevelData.concept}
                  </span>
                  <div className="mb-4 rounded-lg overflow-hidden bg-white/5">
                    {currentLevelData.image}
                  </div>
                  <p className="text-purple-200 leading-relaxed">{currentLevelData.story}</p>
                </div>
              </div>
            </div>

            {/* Task */}
            <div className="bg-white/10 backdrop-blur rounded-lg p-6 mb-6">
              <h3 className="font-bold mb-3 text-yellow-400">Tugasmu:</h3>
              <p className="mb-4">{currentLevelData.task}</p>
              
              <textarea
                value={userCode}
                onChange={(e) => setUserCode(e.target.value)}
                placeholder="Tulis kode di sini..."
                className="w-full h-32 bg-gray-900 text-green-400 font-mono p-4 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-purple-500"
                spellCheck="false"
              />

              <div className="flex gap-3">
                <button
                  onClick={handleSubmit}
                  className="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg font-semibold flex items-center gap-2"
                >
                  <CheckCircle className="w-5 h-5" />
                  Lempar Mantra
                </button>
                <button
                  onClick={() => setShowHint(!showHint)}
                  className="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-semibold"
                >
                  {showHint ? 'Sembunyikan' : 'Lihat'} Petunjuk
                </button>
                {isCompleted && (
                  <button
                    onClick={nextLevel}
                    className="bg-purple-600 hover:bg-purple-700 px-6 py-2 rounded-lg font-semibold flex items-center gap-2 ml-auto"
                  >
                    Level Berikutnya
                    <ArrowRight className="w-5 h-5" />
                  </button>
                )}
              </div>

              {showHint && (
                <div className="mt-4 bg-blue-900/30 p-4 rounded-lg border border-blue-500/30">
                  <p className="text-sm text-blue-300">ðŸ’¡ <strong>Petunjuk:</strong> {currentLevelData.hint}</p>
                </div>
              )}

              {feedback && (
                <div className={`mt-4 p-4 rounded-lg ${
                  feedback.includes('Benar') 
                    ? 'bg-green-900/30 border border-green-500/30' 
                    : 'bg-red-900/30 border border-red-500/30'
                }`}>
                  <p className="font-semibold">{feedback}</p>
                  {isCompleted && (
                    <p className="text-sm mt-2 text-purple-300">
                      ðŸ“š {currentLevelData.explanation}
                    </p>
                  )}
                </div>
              )}
            </div>
          </>
        )}
      </div>
    </div>
  );
};

export default CodeQuest;
